-- Drop the database if it exists and create a new one
DROP DATABASE IF EXISTS gomisDB;
CREATE DATABASE gomisDB;
USE gomisDB;

-- Drop existing tables to avoid conflicts (reverse dependency order)
DROP TABLE IF EXISTS sessions_participants;
DROP TABLE IF EXISTS SESSIONS;
DROP TABLE IF EXISTS INCIDENTS;
DROP TABLE IF EXISTS VIOLATION_RECORD;
DROP TABLE IF EXISTS PARTICIPANTS;
DROP TABLE IF EXISTS APPOINTMENTS;
DROP TABLE IF EXISTS REMARK;
DROP TABLE IF EXISTS GUARDIAN;
DROP TABLE IF EXISTS STUDENT;
DROP TABLE IF EXISTS PARENTS;
DROP TABLE IF EXISTS ADDRESS;
DROP TABLE IF EXISTS USERS;
DROP TABLE IF EXISTS GUIDANCE_COUNSELORS;
DROP TABLE IF EXISTS CONTACT;

-- Create tables in correct dependency order

-- Tables with no dependencies
CREATE TABLE ADDRESS (
    ADDRESS_ID INT PRIMARY KEY AUTO_INCREMENT,
    ADDRESS_HOUSE_NUMBER VARCHAR(50),
    ADDRESS_STREET_SUBDIVISION VARCHAR(50),
    ADDRESS_REGION VARCHAR(50),
    ADDRESS_PROVINCE VARCHAR(50),
    ADDRESS_MUNICIPALITY VARCHAR(50),
    ADDRESS_BARANGAY VARCHAR(50),
    ADDRESS_ZIP_CODE VARCHAR(10),
    INDEX idx_zip_code (ADDRESS_ZIP_CODE)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE PARENTS (
    PARENT_ID INT PRIMARY KEY AUTO_INCREMENT,
    FATHER_LASTNAME VARCHAR(50) NOT NULL,
    FATHER_FIRSTNAME VARCHAR(50) NOT NULL,
    FATHER_MIDDLENAME VARCHAR(50),
    MOTHER_LASTNAME VARCHAR(50) NOT NULL,
    MOTHER_FIRSTNAME VARCHAR(50) NOT NULL,
    MOTHER_MIDDLE_NAME VARCHAR(50)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

CREATE TABLE GUIDANCE_COUNSELORS (
    guidance_COUNSELORS_ID INT PRIMARY KEY AUTO_INCREMENT,
    LAST_NAME VARCHAR(60) NOT NULL,
    FIRST_NAME VARCHAR(60) NOT NULL,
    middle_initial VARCHAR(1) NOT NULL,
    suffix VARCHAR(5),
    gender VARCHAR(10),
    specialization VARCHAR(100),
    contact_num VARCHAR(20),
    email VARCHAR(100),
    position VARCHAR(50),
    profile_picture BLOB
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE CONTACT (
    CONTACT_ID INT PRIMARY KEY AUTO_INCREMENT,
    CONTACT_NUMBER VARCHAR(20) NOT NULL UNIQUE,
    INDEX idx_contact_number (CONTACT_NUMBER)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Tables depending on the above
CREATE TABLE USERS (
    user_id INT PRIMARY KEY AUTO_INCREMENT,
    u_name VARCHAR(100) NOT NULL UNIQUE,
    u_pass VARCHAR(255) NOT NULL,
    guidance_COUNSELORS_ID INT,
    FOREIGN KEY (guidance_COUNSELORS_ID) REFERENCES GUIDANCE_COUNSELORS(guidance_COUNSELORS_ID) ON DELETE SET NULL ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE PARTICIPANTS (
    participant_id INT PRIMARY KEY AUTO_INCREMENT,
    student_uid INT,
    participant_type VARCHAR(100) NOT NULL,
    LAST_NAME VARCHAR(100) NOT NULL,
    FIRST_NAME VARCHAR(100) NOT NULL,
    email VARCHAR(100),
    contact_number VARCHAR(15)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE APPOINTMENTS (
    appointment_id INT PRIMARY KEY AUTO_INCREMENT,
    participant_id INT NOT NULL,
    counselors_id INT,
    appointment_title VARCHAR(50),
    appointment_type VARCHAR(255),
    appointment_date_time DATETIME NOT NULL,
    appointment_notes VARCHAR(100),
    appointment_status VARCHAR(50),
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (participant_id) REFERENCES PARTICIPANTS(participant_id) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (counselors_id) REFERENCES GUIDANCE_COUNSELORS(guidance_COUNSELORS_ID) ON DELETE SET NULL ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE GUARDIAN (
    GUARDIAN_ID INT PRIMARY KEY AUTO_INCREMENT,
    GUARDIAN_LASTNAME VARCHAR(50) NOT NULL,
    GUARDIAN_FIRSTNAME VARCHAR(50) NOT NULL,
    GUARDIAN_MIDDLENAME VARCHAR(50),
    GUARDIAN_RELATIONSHIP VARCHAR(50) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Table depending on the above
CREATE TABLE STUDENT (
    STUDENT_UID INT PRIMARY KEY AUTO_INCREMENT,
    Parent_ID INT,
    GUARDIAN_ID INT,
    ADDRESS_ID INT,
    CONTACT_ID INT,
    STUDENT_LRN VARCHAR(50),
    STUDENT_LASTNAME VARCHAR(50),
    STUDENT_FIRSTNAME VARCHAR(50),
    STUDENT_MIDDLENAME VARCHAR(50),
    STUDENT_SEX VARCHAR(6),
    STUDENT_BIRTHDATE DATE,
    STUDENT_MOTHERTONGUE VARCHAR(50),
    STUDENT_AGE INT,
    STUDENT_IP_TYPE VARCHAR(50),
    STUDENT_RELIGION VARCHAR(50),
    FOREIGN KEY (Parent_ID) REFERENCES PARENTS(PARENT_ID) ON DELETE CASCADE ON UPDATE CASCADE,
	FOREIGN KEY (GUARDIAN_ID) REFERENCES GUARDIAN(GUARDIAN_ID) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (ADDRESS_ID) REFERENCES ADDRESS(ADDRESS_ID) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (CONTACT_ID) REFERENCES CONTACT(CONTACT_ID) ON DELETE SET NULL ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;


CREATE TABLE VIOLATION_RECORD (
    violation_id INT PRIMARY KEY AUTO_INCREMENT,
    student_uid INT NOT NULL,
    violation_type VARCHAR(255),
    violation_description TEXT NOT NULL,
    anecdotal_record TEXT,
    reinforcement VARCHAR(255),
    V_status VARCHAR(50),
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (student_uid) REFERENCES STUDENT(STUDENT_UID) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Tables depending on multiple previous tables
CREATE TABLE INCIDENTS (
    incident_id INT PRIMARY KEY AUTO_INCREMENT,
    student_uid INT,
    participant_id INT,
    violation_id INT,
    incident_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    incident_description TEXT NOT NULL,
    action_taken TEXT,
    recommendation TEXT,
    status VARCHAR(30),
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (student_uid) REFERENCES STUDENT(STUDENT_UID) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (participant_id) REFERENCES PARTICIPANTS(participant_id) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (violation_id) REFERENCES VIOLATION_RECORD(violation_id) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE SESSIONS (
    SESSION_ID INT PRIMARY KEY AUTO_INCREMENT,
    APPOINTMENT_ID INT,
    COUNSELORS_ID INT,
    PARTICIPANT_ID INT,
    VIOLATION_ID INT,
    SESSION_TYPE VARCHAR(50),
    SESSION_DATE_TIME DATETIME,
    SESSION_NOTES TEXT,
    SESSION_STATUS VARCHAR(20),
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (APPOINTMENT_ID) REFERENCES APPOINTMENTS(appointment_id) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (COUNSELORS_ID) REFERENCES GUIDANCE_COUNSELORS(guidance_COUNSELORS_ID) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (PARTICIPANT_ID) REFERENCES PARTICIPANTS(participant_id) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (VIOLATION_ID) REFERENCES VIOLATION_RECORD(violation_id) ON DELETE SET NULL ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE sessions_participants (
    SESSION_ID INT,
    PARTICIPANT_ID INT,
    PRIMARY KEY (SESSION_ID, PARTICIPANT_ID),
    FOREIGN KEY (SESSION_ID) REFERENCES SESSIONS(SESSION_ID) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (PARTICIPANT_ID) REFERENCES PARTICIPANTS(participant_id) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE REMARK (
    REMARK_ID INT PRIMARY KEY AUTO_INCREMENT,
    STUDENT_ID INT,
    REMARK_TEXT VARCHAR(255),
    REMARK_DATE DATE,
    FOREIGN KEY (STUDENT_ID) REFERENCES STUDENT(STUDENT_UID) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Insert data
INSERT INTO GUIDANCE_COUNSELORS (LAST_NAME, FIRST_NAME, middle_initial, suffix, gender, specialization, contact_num, email, position)
VALUES
('Admin', 'Admin', 'A', '', 'Male', 'Test Counselor', '09123456789', 'admin@admin.com', 'Head Counselor');

INSERT INTO USERS (u_name, u_pass, guidance_COUNSELORS_ID)
VALUES
('admin', 'admin', 1);
