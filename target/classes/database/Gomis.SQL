-- SQLBook: Code
DROP DATABASE IF EXISTS gomisdb;
CREATE DATABASE gomisdb;
USE gomisdb;

-- 1. Drop tables with foreign keys that depend on other tables
DROP TABLE IF EXISTS SESSIONS_PARTICIPANTS;
DROP TABLE IF EXISTS SESSIONS;
DROP TABLE IF EXISTS APPOINTMENTS;
DROP TABLE IF EXISTS VIOLATION_RECORD;
DROP TABLE IF EXISTS INCIDENTS;
DROP TABLE IF EXISTS REMARK;
DROP TABLE IF EXISTS USERS;
DROP TABLE IF EXISTS PARTICIPANTS;
DROP TABLE IF EXISTS STUDENT;

-- 2. Drop independent tables last
DROP TABLE IF EXISTS ADDRESS;
DROP TABLE IF EXISTS CONTACT;
DROP TABLE IF EXISTS PARENTS;
DROP TABLE IF EXISTS GUARDIAN;
DROP TABLE IF EXISTS GUIDANCE_COUNSELORS;

-- Create tables in correct dependency order

-- 1. Independent tables first (no foreign keys)
CREATE TABLE ADDRESS (
    ADDRESS_ID INT PRIMARY KEY AUTO_INCREMENT,
    ADDRESS_HOUSE_NUMBER VARCHAR(50),
    ADDRESS_STREET_SUBDIVISION VARCHAR(100),
    ADDRESS_REGION VARCHAR(100),
    ADDRESS_PROVINCE VARCHAR(100),
    ADDRESS_MUNICIPALITY VARCHAR(100),
    ADDRESS_BARANGAY VARCHAR(100),
    ADDRESS_ZIP_CODE VARCHAR(20),
    INDEX idx_zip_code (ADDRESS_ZIP_CODE)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE CONTACT (
    CONTACT_ID INT PRIMARY KEY AUTO_INCREMENT,
    CONTACT_NUMBER VARCHAR(20) NOT NULL UNIQUE,
    INDEX idx_contact_number (CONTACT_NUMBER)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE PARENTS (
    PARENT_ID INT PRIMARY KEY AUTO_INCREMENT,
    FATHER_LASTNAME VARCHAR(50) NOT NULL,
    FATHER_FIRSTNAME VARCHAR(50) NOT NULL,
    FATHER_MIDDLENAME VARCHAR(50),
    MOTHER_LASTNAME VARCHAR(50) NOT NULL,
    MOTHER_FIRSTNAME VARCHAR(50) NOT NULL,
    MOTHER_MIDDLE_NAME VARCHAR(50)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

CREATE TABLE GUARDIAN (
    GUARDIAN_ID INT PRIMARY KEY AUTO_INCREMENT,
    GUARDIAN_LASTNAME VARCHAR(100) NOT NULL,
    GUARDIAN_FIRST_NAME VARCHAR(100) NOT NULL,
    GUARDIAN_MIDDLE_NAME VARCHAR(100),
    GUARDIAN_RELATIONSHIP VARCHAR(50) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE GUIDANCE_COUNSELORS (
    GUIDANCE_COUNSELOR_ID INT PRIMARY KEY AUTO_INCREMENT,
    LAST_NAME VARCHAR(100) NOT NULL,
    FIRST_NAME VARCHAR(100) NOT NULL,
    MIDDLE_INITIAL VARCHAR(10) NOT NULL,
    SUFFIX VARCHAR(10),
    GENDER VARCHAR(10),
    SPECIALIZATION VARCHAR(100),
    CONTACT_NUM VARCHAR(20),
    EMAIL VARCHAR(100),
    POSITION VARCHAR(100),
    PROFILE_PICTURE BLOB
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 2. Tables that depend on the above tables
CREATE TABLE STUDENT (
    STUDENT_UID INT PRIMARY KEY AUTO_INCREMENT,
    PARENT_ID INT,
    GUARDIAN_ID INT,
    ADDRESS_ID INT,
    CONTACT_ID INT,
    STUDENT_LRN VARCHAR(50),
    STUDENT_LASTNAME VARCHAR(100),
    STUDENT_FIRSTNAME VARCHAR(100),
    STUDENT_MIDDLENAME VARCHAR(100),
    STUDENT_SEX VARCHAR(10),
    STUDENT_BIRTHDATE DATE,
    STUDENT_MOTHERTONGUE VARCHAR(50),
    STUDENT_AGE INT,
    STUDENT_IP_TYPE VARCHAR(50),
    STUDENT_RELIGION VARCHAR(50),
    FOREIGN KEY (PARENT_ID) REFERENCES PARENTS(PARENT_ID) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (GUARDIAN_ID) REFERENCES GUARDIAN(GUARDIAN_ID) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (ADDRESS_ID) REFERENCES ADDRESS(ADDRESS_ID) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (CONTACT_ID) REFERENCES CONTACT(CONTACT_ID) ON DELETE SET NULL ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE PARTICIPANTS (
    PARTICIPANT_ID INT PRIMARY KEY AUTO_INCREMENT,
    STUDENT_UID INT,
    PARTICIPANT_TYPE VARCHAR(100) NOT NULL,
    PARTICIPANT_LASTNAME VARCHAR(100) NOT NULL,
    PARTICIPANT_FIRSTNAME VARCHAR(100) NOT NULL,
    EMAIL VARCHAR(100),
    CONTACT_NUMBER VARCHAR(20),
    FOREIGN KEY (STUDENT_UID) REFERENCES STUDENT(STUDENT_UID)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE USERS (
    USER_ID INT PRIMARY KEY AUTO_INCREMENT,
    U_NAME VARCHAR(100) NOT NULL UNIQUE,
    U_PASS VARCHAR(255) NOT NULL,
    GUIDANCE_COUNSELOR_ID INT,
    FOREIGN KEY (GUIDANCE_COUNSELOR_ID) REFERENCES GUIDANCE_COUNSELORS(GUIDANCE_COUNSELOR_ID) ON DELETE SET NULL ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 3. Tables that depend on PARTICIPANTS and others
CREATE TABLE REMARK (
    REMARK_ID INT PRIMARY KEY AUTO_INCREMENT,
    STUDENT_ID INT,
    REMARK_TEXT VARCHAR(255),
    REMARK_DATE DATE,
    FOREIGN KEY (STUDENT_ID) REFERENCES STUDENT(STUDENT_UID) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE INCIDENTS (
    INCIDENT_ID INT PRIMARY KEY AUTO_INCREMENT,
    PARTICIPANT_ID INT,
    INCIDENT_DATE DATE_TIME,
    INCIDENT_DESCRIPTION TEXT NOT NULL,
    ACTION_TAKEN TEXT,
    RECOMMENDATION TEXT,
    STATUS VARCHAR(50),
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (PARTICIPANT_ID) REFERENCES PARTICIPANTS(PARTICIPANT_ID) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE VIOLATION_RECORD (
    VIOLATION_ID INT PRIMARY KEY AUTO_INCREMENT,
    STUDENT_UID INT NOT NULL,
    VIOLATION_TYPE VARCHAR(255),
    VIOLATION_DESCRIPTION TEXT NOT NULL,
    ANECDOTAL_RECORD TEXT,
    REINFORCEMENT VARCHAR(255),
    V_STATUS VARCHAR(50),
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (STUDENT_UID) REFERENCES STUDENT(STUDENT_UID) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE APPOINTMENTS (
    APPOINTMENT_ID INT PRIMARY KEY AUTO_INCREMENT,
    PARTICIPANT_ID INT NOT NULL,
    GUIDANCE_COUNSELOR_ID INT,
    APPOINTMENT_TITLE VARCHAR(50),
    APPOINTMENT_TYPE VARCHAR(255),
    APPOINTMENT_DATE_TIME DATE_TIME NOT NULL,
    APPOINTMENT_NOTES VARCHAR(100),
    APPOINTMENT_STATUS VARCHAR(50),
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (PARTICIPANT_ID) REFERENCES PARTICIPANTS(PARTICIPANT_ID) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (GUIDANCE_COUNSELOR_ID) REFERENCES GUIDANCE_COUNSELORS(GUIDANCE_COUNSELOR_ID) ON DELETE SET NULL ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 4. Tables that depend on the above tables
CREATE TABLE SESSIONS (
    SESSION_ID INT PRIMARY KEY AUTO_INCREMENT,
    APPOINTMENT_ID INT,
    GUIDANCE_COUNSELOR_ID INT,
    PARTICIPANT_ID INT,
    VIOLATION_ID INT,
    SESSION_TYPE VARCHAR(50),
    SESSION_DATE_TIME DATE_TIME,
    SESSION_NOTES TEXT,
    SESSION_STATUS VARCHAR(20),
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (APPOINTMENT_ID) REFERENCES APPOINTMENTS(APPOINTMENT_ID) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (GUIDANCE_COUNSELOR_ID) REFERENCES GUIDANCE_COUNSELORS(GUIDANCE_COUNSELOR_ID) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (PARTICIPANT_ID) REFERENCES PARTICIPANTS(PARTICIPANT_ID) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (VIOLATION_ID) REFERENCES VIOLATION_RECORD(VIOLATION_ID) ON DELETE SET NULL ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE SESSIONS_PARTICIPANTS (
    SESSION_ID INT,
    PARTICIPANT_ID INT,
    PRIMARY KEY (SESSION_ID, PARTICIPANT_ID),
    FOREIGN KEY (SESSION_ID) REFERENCES SESSIONS(SESSION_ID) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (PARTICIPANT_ID) REFERENCES PARTICIPANTS(PARTICIPANT_ID) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Insert data
INSERT INTO GUIDANCE_COUNSELORS (LAST_NAME, FIRST_NAME, MIDDLE_INITIAL, SUFFIX, GENDER, SPECIALIZATION, CONTACT_NUM, EMAIL, POSITION)
VALUES
('Admin', 'Admin', 'A', '', 'Male', 'Test Counselor', '09123456789', 'admin@admin.com', 'Head Counselor');

INSERT INTO USERS (U_NAME, U_PASS, GUIDANCE_COUNSELOR_ID)
VALUES
('admin', 'admin', 1);
